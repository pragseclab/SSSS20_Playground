

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>SSSS’20 Playground (Short version) &mdash; SSSS20 Less Is More Playground  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
 <script type="text/javascript">
    $(document).ready(function() {
        $(document).ready(function () {
        $('a[href^="http://"], a[href^="https://"]').not('a[class*=internal]').attr('target', '_blank');
        });

        $(".toggle > *").hide();
        $(".toggle .admonition-title").show();
        $(".toggle .admonition-title").click(function() {
            $(this).parent().children().not(".admonition-title").toggle(400);
            $(this).parent().children(".admonition-title").toggleClass("open");
        })
    });
</script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> SSSS20 Less Is More Playground
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">SSSS’20 Playground (Short version)</a><ul>
<li><a class="reference internal" href="#installation"><em class="fa fa-eye"></em> Installation</a></li>
<li><a class="reference internal" href="#docker-containers"><em class="fa fa-eye"></em> Docker Containers</a></li>
<li><a class="reference internal" href="#accessing-the-containers-video-0-26"><em class="fa fa-arrow-right"></em> 1. Accessing The Containers [Video 0:26]</a></li>
<li><a class="reference internal" href="#adding-new-applications-to-the-pipeline-video-0-53"><em class="fa fa-arrow-right"></em> 2. Adding New Applications To The Pipeline [Video 0:53]</a></li>
<li><a class="reference internal" href="#adding-the-cve-information-to-the-vulnerability-database-video-2-39"><em class="fa fa-arrow-right"></em> 3. Adding The CVE Information To The Vulnerability Database [Video 2:39]</a></li>
<li><a class="reference internal" href="#finding-and-running-the-exploit-video-10-57"><em class="fa fa-arrow-right"></em> 4. Finding And Running The Exploit [Video 10:57]</a></li>
<li><a class="reference internal" href="#using-the-application-recording-the-code-coverage"><em class="fa fa-arrow-right"></em> 5. Using The Application &amp; Recording The Code Coverage</a></li>
<li><a class="reference internal" href="#debloating-the-application-video-19-17"><em class="fa fa-arrow-right"></em> 6. Debloating The Application [Video 19:17]</a></li>
<li><a class="reference internal" href="#verifying-the-functionality-of-the-application-video-20-02"><em class="fa fa-arrow-right"></em> 7. Verifying The Functionality Of The Application [Video 20:02]</a></li>
<li><a class="reference internal" href="#running-the-exploit-on-the-debloated-version-video-20-22"><em class="fa fa-arrow-right"></em> 8. Running The Exploit On The Debloated Version [Video 20:22]</a></li>
<li><a class="reference internal" href="#source-code-metrics-after-debloating-video-20-52"><em class="fa fa-arrow-right"></em> 9. Source Code Metrics After Debloating [Video 20:52]</a></li>
<li><a class="reference internal" href="#working-with-other-debloated-applications">Working With Other Debloated Applications</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SSSS20 Less Is More Playground</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>SSSS’20 Playground (Short version)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/shortversion.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ssss-20-playground-short-version">
<h1><a class="toc-backref" href="#id1">SSSS’20 Playground (Short version)</a><a class="headerlink" href="#ssss-20-playground-short-version" title="Permalink to this headline">¶</a></h1>
<p>Welcome to the <strong>Less is more</strong> playground for SSSS’20. In this tutorial, you will get hands on experience with using our pipeline to debloat a phpMyAdmin web application. You will become familiar with the debloating administration panel, and see how a real exploit is stopped after debloating. You are following the <strong>short version</strong> of this playground.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Throughout this tutorial, <strong>“Action Items”</strong> marked with <em class="fa fa-arrow-right"></em> icon, are concrete tasks that you need to follow.</p>
<p>There is also <strong>“Information Items”</strong> marked with <em class="fa fa-eye"></em> icon.
These items provide the context about the task at hand or the idea behind it.
While it is highly suggested to read through them, there are no concrete steps accompanied by them.</p>
</div>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ssss-20-playground-short-version" id="id1">SSSS’20 Playground (Short version)</a></p>
<ul>
<li><p><a class="reference internal" href="#installation" id="id2"><em class="fa fa-eye"></em> Installation</a></p></li>
<li><p><a class="reference internal" href="#docker-containers" id="id3"><em class="fa fa-eye"></em> Docker Containers</a></p></li>
<li><p><a class="reference internal" href="#accessing-the-containers-video-0-26" id="id4"><em class="fa fa-arrow-right"></em> 1. Accessing The Containers [Video 0:26]</a></p></li>
<li><p><a class="reference internal" href="#adding-new-applications-to-the-pipeline-video-0-53" id="id5"><em class="fa fa-arrow-right"></em> 2. Adding New Applications To The Pipeline [Video 0:53]</a></p></li>
<li><p><a class="reference internal" href="#adding-the-cve-information-to-the-vulnerability-database-video-2-39" id="id6"><em class="fa fa-arrow-right"></em> 3. Adding The CVE Information To The Vulnerability Database [Video 2:39]</a></p></li>
<li><p><a class="reference internal" href="#finding-and-running-the-exploit-video-10-57" id="id7"><em class="fa fa-arrow-right"></em> 4. Finding And Running The Exploit [Video 10:57]</a></p></li>
<li><p><a class="reference internal" href="#using-the-application-recording-the-code-coverage" id="id8"><em class="fa fa-arrow-right"></em> 5. Using The Application &amp; Recording The Code Coverage</a></p></li>
<li><p><a class="reference internal" href="#debloating-the-application-video-19-17" id="id9"><em class="fa fa-arrow-right"></em> 6. Debloating The Application [Video 19:17]</a></p></li>
<li><p><a class="reference internal" href="#verifying-the-functionality-of-the-application-video-20-02" id="id10"><em class="fa fa-arrow-right"></em> 7. Verifying The Functionality Of The Application [Video 20:02]</a></p></li>
<li><p><a class="reference internal" href="#running-the-exploit-on-the-debloated-version-video-20-22" id="id11"><em class="fa fa-arrow-right"></em> 8. Running The Exploit On The Debloated Version [Video 20:22]</a></p></li>
<li><p><a class="reference internal" href="#source-code-metrics-after-debloating-video-20-52" id="id12"><em class="fa fa-arrow-right"></em> 9. Source Code Metrics After Debloating [Video 20:52]</a></p></li>
<li><p><a class="reference internal" href="#working-with-other-debloated-applications" id="id13">Working With Other Debloated Applications</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="installation">
<h2><a class="toc-backref" href="#id2"><em class="fa fa-eye"></em> Installation</a><a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Skip the installation section for SSSS’20 event as the environment has already been setup for you.</p>
</div>
<div class="toggle admonition">
<p class="admonition-title">Installation details</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Download the project files <a class="reference external" href="https://drive.google.com/file/d/11Dh2_uWR5XqSUCCsBIvfWZVR6sHraFVv/view?usp=sharing">debloating_phpMyAdmin.tar.gz</a></p></li>
<li><p>Decompress the tar file <code class="code docutils literal notranslate"><span class="pre">tar</span> <span class="pre">zxvf</span> <span class="pre">debloating_phpMyAdmin.tar.gz</span></code></p></li>
<li><p>Run <code class="code docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span></code> in the root directory</p></li>
<li><p>You can view the logs using <code class="code docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">logs</span> <span class="pre">-f</span> <span class="pre">-t</span></code></p></li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="docker-containers">
<h2><a class="toc-backref" href="#id3"><em class="fa fa-eye"></em> Docker Containers</a><a class="headerlink" href="#docker-containers" title="Permalink to this headline">¶</a></h2>
<img alt="_images/SSSS20.png" class="align-center" src="_images/SSSS20.png" />
<ul class="simple">
<li><p><strong>Public Web:</strong> This docker container is the public side of your application. It is accessible on <a class="reference external" href="http://localhost:8084">http://localhost:8084</a>. Public internet users will interact with the applications over this port. No training and code coverage recording is performed on this container. You will mount your attacks on this container.</p></li>
<li><p><strong>Training Web:</strong> This container is the training side of your application. It is accessible for trusted users during your training phase. It is accessible on <a class="reference external" href="http://localhost:8085">http://localhost:8085</a>. You would run Selenium and Monkey tests against this container.</p></li>
<li><p><strong>Admin:</strong> This container hosts the admin panel as well as management phpMyAdmin instance of the application. It is used to view the debloating stats and perform debloating. It is accessible on <a class="reference external" href="http://localhost:8086">http://localhost:8086</a>.</p></li>
<li><p><strong>db:</strong> This container hosts the databases for your web applications as well as the code coverage information. It has no public interface but is accessible to other docker containers through the “db” hostname.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The same web application files are mounted as a volume on web and admin containers. That means the “web” directory includes the same files that you would see under “/var/www/html/” inside the docker containers.</p></li>
<li><p>The credentials to log in to phpMyAdmin is: username: root, password: root.</p></li>
</ul>
</div>
</div>
<div class="section" id="accessing-the-containers-video-0-26">
<h2><em class="fa fa-arrow-right"></em> 1. Accessing The Containers <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=26">[Video 0:26]</a><a class="headerlink" href="#accessing-the-containers-video-0-26" title="Permalink to this headline">¶</a></h2>
<p>You can run <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> to see if the containers are started already. If you don’t see the containers, navigate to <code class="code docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/home/ubuntu/debloating_phpMyAdmin/</span></code> and run <code class="code docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span></code>. This will start the containers. You can verify this using <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> again.</p>
<p>If you need shell access to any of the containers, you need to run the /bin/bash process inside the containers. We have provided shell scripts to aid with this process. These scripts will find the container id and execute the /bin/bash process for you. The scripts to access the containers are in the root directory of the applicaton which is currently at <code class="code docutils literal notranslate"><span class="pre">/home/ubuntu/debloating_phpMyAdmin/</span></code>. For <strong>web</strong> containers, the web applications are under <code class="code docutils literal notranslate"><span class="pre">/var/www/html/</span></code> and the database used for debloating panel is under <strong>db</strong> container named <code class="code docutils literal notranslate"><span class="pre">code_coverage</span></code>.</p>
<ul class="simple">
<li><p>Public Web: <code class="code docutils literal notranslate"><span class="pre">./ssh_public_web.sh</span></code></p></li>
<li><p>Training Web: <code class="code docutils literal notranslate"><span class="pre">./ssh_training_web.sh</span></code></p></li>
<li><p>Admin: <code class="code docutils literal notranslate"><span class="pre">./ssh_admin.sh</span></code></p></li>
<li><p>db: <code class="code docutils literal notranslate"><span class="pre">./ssh_db.sh</span></code></p></li>
</ul>
</div>
<div class="section" id="adding-new-applications-to-the-pipeline-video-0-53">
<h2><em class="fa fa-arrow-right"></em> 2. Adding New Applications To The Pipeline <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=53">[Video 0:53]</a><a class="headerlink" href="#adding-new-applications-to-the-pipeline-video-0-53" title="Permalink to this headline">¶</a></h2>
<p>Before we debloat a web application, we first have to add its information and track its source files from our admin debloating panel. You can take a look at the admin panel walkthrough for more detail: <a class="reference external" href="https://debloating.com/walkthrough.html">https://debloating.com/walkthrough.html</a></p>
<p>Steps to follow:</p>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>I. Navigate to admin</strong></div>
<div class="line">Navigate to the admin panel (<a class="reference external" href="http://localhost:8086/admin">http://localhost:8086/admin</a>).</div>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>II. Add software</strong></div>
<div class="line">Add the target application under the “Software” tab. In this case “phpMyAdmin”.</div>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>III. Add software version</strong></div>
<div class="line">Add the target version under the “Software Version” tab. In this case “4.4.15.6”. This allows us to add multiple versions of the same web application to our code coverage database.</div>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>IV. Add application files</strong></div>
<div class="line">Under the “Debloating” tab, add the current directory for the target application. “/var/www/html/phpMyAdmin-4.4.15.6-all-languages” in our case. This step will add the list of files to the code_coverage database so that we can track their line coverage later on.</div>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>V. Prepare the class destructors</strong></div>
<div class="line">Under the “Debloating” tab (<a class="reference external" href="http://localhost:8086/admin/software_file/description">http://localhost:8086/admin/software_file/description</a>), click on the “Rewrite Destructors” button. This will make sure that we record the full code coverage for our target application. This step can take around a minute and then it will show a text log of the destructors that have been rewritten and prepared for debloating.</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em class="fa fa-eye"></em> Preparing the destructors requires admin panels access to modify the source code of our target web application. The same “web” directory which includes web application files on the host machine is mounted to “/var/www/html” directory under web and admin docker containers. If you see a permission error while rewriting the destructors, use <code class="code docutils literal notranslate"><span class="pre">./ssh_admin.sh</span></code> script to get into the admin container, navigate to the target web application directory (<code class="code docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/var/www/html/phpMyAdmin-4.4.15.6-all-languages</span></code>) and change the owner of the files to the web server user (<code class="code docutils literal notranslate"><span class="pre">chown</span> <span class="pre">-R</span> <span class="pre">www-data:www-data</span> <span class="pre">.</span></code>).</p>
</div>
</div>
<div class="section" id="adding-the-cve-information-to-the-vulnerability-database-video-2-39">
<h2><em class="fa fa-arrow-right"></em> 3. Adding The CVE Information To The Vulnerability Database <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=158">[Video 2:39]</a><a class="headerlink" href="#adding-the-cve-information-to-the-vulnerability-database-video-2-39" title="Permalink to this headline">¶</a></h2>
<p>By adding the information about known vulnerabilities, we can identify if debloating is able to remove them before actually modifying the source of our applications. The first step to add each CVE to our database is to identify the files and lines within those files that make the application vulnerable. In this tutorial, we focus on “CVE-2016-5734”.</p>
<p>Steps to follow:</p>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>I. Find CVE information</strong></div>
<div class="line">Look up the CVE id (CVE-2016-5734) in Google and navigate to sites such as MITRE or NVD (National Vulnerability Database) for vulnerability details.</div>
</div>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<p><a class="reference external" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-5734">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-5734</a></p>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-eye"></em> <strong>II. Understand the vulnerability</strong></div>
<div class="line">Take your time to read about this vulnerability and get a general understanding of it. This is required later on when we mark the lines within the source code that are related to this vulnerability.</div>
</div>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><p>This vulnerability affects the <code class="code docutils literal notranslate"><span class="pre">preg_replace</span></code> function. By injecting the <code class="code docutils literal notranslate"><span class="pre">/e</span></code> flag as input to this function we can make PHP run <code class="code docutils literal notranslate"><span class="pre">eval</span></code> on the output of regex find and replace. To do this, we have to inject <code class="code docutils literal notranslate"><span class="pre">/e</span></code> and also use a <code class="code docutils literal notranslate"><span class="pre">null</span> <span class="pre">byte</span></code> to terminate the rest of the string to make this exploit work. Read more at <a class="reference external" href="https://bitquark.co.uk/blog/2013/07/23/the_unexpected_dangers_of_preg_replace">https://bitquark.co.uk/blog/2013/07/23/the_unexpected_dangers_of_preg_replace</a></p>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>III. Find the patch</strong></div>
<div class="line">Follow the link to the phpMyAdmin website including the changelogs for the fix to this vulnerability, find the diff of patch files for phpMyAdmin 4.4 branch.</div>
</div>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><ul class="simple">
<li><p>Navigate to <a class="reference external" href="https://www.phpmyadmin.net/security/PMASA-2016-27/">https://www.phpmyadmin.net/security/PMASA-2016-27/</a></p></li>
<li><p>Find <a class="reference external" href="https://github.com/phpmyadmin/phpmyadmin/commit/33d1373">https://github.com/phpmyadmin/phpmyadmin/commit/33d1373</a></p></li>
<li><p>Find <a class="reference external" href="https://github.com/phpmyadmin/phpmyadmin/commit/daf3751">https://github.com/phpmyadmin/phpmyadmin/commit/daf3751</a></p></li>
</ul>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>IV. Identify the affected files</strong></div>
<div class="line">By looking at the Git diffs and using your judgment, list the filenames that are affected by this vulnerability.</div>
</div>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><ul class="simple">
<li><p>libraries/TableSearch.class.php</p></li>
<li><p>libraries/Tracker.class.php</p></li>
<li><p>libraries/plugins/export/ExportSql.class.php</p></li>
<li><p>libraries/tbl_columns_definition_form.lib.php</p></li>
<li><p>test/libraries/core/PMA_warnMissingExtension_test.php</p></li>
</ul>
<p><strong>test/libraries/core/PMA_warnMissingExtension_test.php</strong> is included in the patch but since it is a unit test, it is only accessible locally and does not directly contribute to the vulnerability, also it is not exploitable.</p>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>V. Match the vulnerable lines</strong></div>
<div class="line">The process to prepare PHP class destructors for debloating rewrites the source code and at times changes the line number compared to the one in Git diff. To make sure the line number mapping is correct, we should not rely on the line numbers of the Git commit. Instead, we confirm the line numbers on our own local copy of the application. For this, using your favorite text editor look into the <code class="code docutils literal notranslate"><span class="pre">/home/ubuntu/debloating_phpMyAdmin/web/phpMyAdmin-4.4.15.6-all-languages/</span></code> directory mounted under your users home directory on the virtual machine and find the lines that were removed or changed from the vulnerable version of the application (red lines). If you are using gedit over VNC, you can enable line numbers by clicking on the cog icon, under preferences, click display line numbers.</div>
</div>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><ul class="simple">
<li><p>libraries/TableSearch.class.php: 1041</p></li>
<li><p>libraries/Tracker.class.php: 662</p></li>
<li><p>libraries/plugins/export/ExportSql.class.php: 854</p></li>
<li><p>libraries/tbl_columns_definition_form.lib.php: 488</p></li>
</ul>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>VI. Identify the function lines</strong></div>
<div class="line">Whenever the vulnerability resides inside a PHP function, we also include that information in our database. For that, write down the line number of the first executable line within the function that includes the vulnerable code (i.e., skip function’s opening curly brace and comment lines).</div>
</div>
<p>In the following example, the vulnerability is on line <strong>448</strong> and the first executable inside the function is on line <strong>447</strong>. So in this case we note down <strong>PMA_getNumberOfFieldsFromRequest():447</strong>. Make sure to write down both the function name as well as the line numbers, we will need both of them to populate our database later. In our debloating pipeline, we use this line number to mark functions as covered or not, the function name is only used as a label in the admin panel (i.e., you can include or ignore function parameters when adding function name to the database).</p>
<img alt="_images/sourcecode.png" class="align-center" src="_images/sourcecode.png" />
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><ul class="simple">
<li><p>libraries/TableSearch.class.php:<strong>_getRegexReplaceRows($columnIndex, $find, $replaceWith, $charSet):1032</strong></p></li>
<li><p>libraries/Tracker.class.php:<strong>handleQuery($query):617</strong></p></li>
<li><p>libraries/plugins/export/ExportSql.class.php:<strong>getTableDef( $db, $table, $crlf, $error_url, $show_dates = false, $add_semicolon = true, $view = false, $update_indexes_increments = true, $aliases = array() ):755</strong></p></li>
<li><p>libraries/tbl_columns_definition_form.lib.php:<strong>PMA_getHtmlForTransformation($columnNumber, $ci, $ci_offset, $available_mime, $columnMeta, $mime_map, $type_prefix ):483</strong></p></li>
</ul>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>VII. Add CVE information to database</strong></div>
<div class="line">With this information, go back to the admin panel, add the CVE information under the <code class="code docutils literal notranslate"><span class="pre">CVE</span></code> tab. You can enter the CVE id and leave Name and Description fields empty. Under the <code class="code docutils literal notranslate"><span class="pre">Software</span> <span class="pre">Vulnerabilities</span></code> tab, mark phpMyAdmin 4.4.15 as the software version that is affected by this CVE.  Then, under the <code class="code docutils literal notranslate"><span class="pre">Vulnerable</span> <span class="pre">Files</span> <span class="pre">Mapping</span></code> tab, add the path to each file from the root of the application. In a similar fashion, add the <code class="code docutils literal notranslate"><span class="pre">Vulnerable</span> <span class="pre">Lines</span> <span class="pre">Mapping</span></code> and <code class="code docutils literal notranslate"><span class="pre">Vulnerable</span> <span class="pre">Functions</span> <span class="pre">Mapping</span></code> for the same CVE.</div>
</div>
</div>
<div class="section" id="finding-and-running-the-exploit-video-10-57">
<h2><em class="fa fa-arrow-right"></em> 4. Finding And Running The Exploit <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=657">[Video 10:57]</a><a class="headerlink" href="#finding-and-running-the-exploit-video-10-57" title="Permalink to this headline">¶</a></h2>
<p>To demonstrate the power of debloating in removing actual vulnerabilities, we focus on available exploits. Your task for this step is to find the exploit code for CVE-2016-5734 vulnerability. Websites such as <a class="reference external" href="https://www.exploit-db.com/">https://www.exploit-db.com/</a> and <a class="reference external" href="https://github.com/">https://github.com/</a> are good sources to look for these exploits.</p>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><p><a class="reference external" href="https://www.exploit-db.com/exploits/40185">https://www.exploit-db.com/exploits/40185</a></p>
</div></blockquote>
</div>
<p><em class="fa fa-arrow-right"></em> Once you download the exploit code, run it against the public interface of your web application which is located at <a class="reference external" href="http://localhost:8084/phpMyAdmin-4.4.15.6-all-languages">http://localhost:8084/phpMyAdmin-4.4.15.6-all-languages</a>.</p>
<p><em class="fa fa-eye"></em> This exploit takes advantage of a vulnerablity in <code class="code docutils literal notranslate"><span class="pre">preg_replace</span></code> function within PHP. Normally, this function takes a regular expression, applies it to a text and replaces every occurance with another text. By supplying the <code class="code docutils literal notranslate"><span class="pre">/e</span></code> modifier, PHP will interpret the output of this function as PHP code and execute it, essentially turning it into an eval function call.
By appending /e to our regex and using a null string terminator, we can run arbitrary code on target system and achieve RCE.
In the public exploit for this vulnerability, but default, the payload is set to <code class="code docutils literal notranslate"><span class="pre">system('uname</span> <span class="pre">-a');</span></code> but it can be changed to any arbitrary code that will be executed under the PHP/Apache user permissions.</p>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><ul class="simple">
<li><p>Exploit execution: <code class="code docutils literal notranslate"><span class="pre">python3</span> <span class="pre">exploits/40185.py</span> <span class="pre">http://localhost:8084/phpMyAdmin-4.4.15.6-all-languages</span> <span class="pre">-u</span> <span class="pre">root</span> <span class="pre">-p</span> <span class="pre">root</span> <span class="pre">-d</span> <span class="pre">mysql</span></code></p></li>
<li><p>Result: x bb8440b2284f 4.19.84-microsoft-standard #1 SMP Wed Nov 13 11:44:37 UTC 2019 x86_64 GNU/Linux</p></li>
<li><p>Requires python requests library to be installed.</p></li>
</ul>
</div></blockquote>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are following the video, skip from 12:07 to 17:23 for next section.</p>
</div>
</div>
<div class="section" id="using-the-application-recording-the-code-coverage">
<h2><a class="toc-backref" href="#id8"><em class="fa fa-arrow-right"></em> 5. Using The Application &amp; Recording The Code Coverage</a><a class="headerlink" href="#using-the-application-recording-the-code-coverage" title="Permalink to this headline">¶</a></h2>
<p>In order to debloat the application, first we have to record a representative code coverage. This way, we can identify the parts of the application that are required by the users. For instance, if users exercise the create/drop database functionality, we want to keep it and remove the export functionality if it has never been used.
In this section, we interact with the “training web” container hosted over <code class="code docutils literal notranslate"><span class="pre">http://localhost:8085/phpMyAdmin-4.4.15.6-all-languages</span></code>.</p>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>I. Work with the application</strong></div>
<div class="line">Login to <code class="code docutils literal notranslate"><span class="pre">http://localhost:8085/phpMyAdmin-4.4.15.6-all-languages</span></code> and start navigating to several pages within the application. This way, the debloating engine will know which features are required by the users and will remove the rest.</div>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>II. Check the coverage in the admin panel</strong> <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=1043">[Video 17:23]</a></div>
<div class="line">To make sure we have correctly recorded the code coverage as you are working with the application, navigate to <a class="reference external" href="http://localhost:8086/admin/report">http://localhost:8086/admin/report</a>. By clicking on the tests for our target web application, you can view specific files (e.g., index.php) being used and you can also view the coverage of specific lines within these files.</div>
</div>
<p>Under the same page:</p>
<ul class="simple">
<li><p><strong>File Coverage</strong> shows the vulnerable files and whether they were used during that specific test. Similarly, you can use the multi select checkbox and the buttons on top to get the same information for the union of multiple tests.</p></li>
<li><p><strong>Function Coverage</strong> reports whether a vulnerable function has been triggered during the tests or not. Notice that only the vulnerable functions are shown where the parent file has been covered.</p></li>
<li><p><strong>Line Coverage</strong> shows whether the specific lines for the specific CVEs were executed during tests.</p></li>
<li><p>By clicking on individual test groups, you can see specific files and the line numbers that were executed within those files.</p></li>
</ul>
<p>You should see that some files related to this vulnerability has been covered but none of the functions nor the lines are triggered. As a result, function debloating should be able to fully remove this CVE from our applications and prevent exploitation.</p>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><ul class="simple">
<li><p>File <code class="code docutils literal notranslate"><span class="pre">libraries/tbl_columns_definition_form.lib.php</span></code> is covered.</p></li>
<li><p>File <code class="code docutils literal notranslate"><span class="pre">libraries/Tracker.class.php</span></code> is covered.</p></li>
<li><p>File <code class="code docutils literal notranslate"><span class="pre">libraries/plugins/export/ExportSql.class.php</span></code> is not covered.</p></li>
<li><p>File <code class="code docutils literal notranslate"><span class="pre">libraries/TableSearch.class.php</span></code> is not covered.</p></li>
<li><p>None of the functions or lines are covered.</p></li>
</ul>
</div></blockquote>
</div>
<div class="line-block">
<div class="line"><em class="fa fa-arrow-right"></em> <strong>III. Look at the source code metrics</strong> <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=1098">[Video 18:18]</a></div>
<div class="line">Before we debloat the application, let’s look at some of the metrics that can be extracted from the source code. For that, we use the phpmetrics (<a class="reference external" href="https://github.com/phpmetrics/PhpMetrics">https://github.com/phpmetrics/PhpMetrics</a>) package. It comes preinstalled in the <strong>Training Web</strong> container.</div>
</div>
<div class="line-block">
<div class="line">Use the <code class="code docutils literal notranslate"><span class="pre">ssh_training_web.sh</span></code> script to get a shell into the corresponding container. Navigate to <code class="code docutils literal notranslate"><span class="pre">/var/www/html/</span></code> directory where the applications are.</div>
<div class="line">Run <code class="code docutils literal notranslate"><span class="pre">phpmetrics</span> <span class="pre">phpMyAdmin-4.4.15.6-all-languages/</span></code>. This will take a while and generate results such as Logical Lines Of Code and Average Cyclomatic Complexity by Class. Take a note of these results, we will compare the results after debloating as well.</div>
</div>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><div class="line-block">
<div class="line">Executing system analyzes…</div>
<div class="line">LOC Lines of code                                       90473</div>
<div class="line">Logical lines of code                                    57049</div>
<div class="line">…</div>
<div class="line">Complexity Average Cyclomatic</div>
<div class="line">complexity by class                                     23.98</div>
<div class="line">Average Relative system complexity          520.08</div>
<div class="line">Average Difficulty                                        16.13</div>
<div class="line">…</div>
<div class="line">Done</div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="debloating-the-application-video-19-17">
<h2><em class="fa fa-arrow-right"></em> 6. Debloating The Application <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=1157">[Video 19:17]</a><a class="headerlink" href="#debloating-the-application-video-19-17" title="Permalink to this headline">¶</a></h2>
<p>Once you are happy with the training, we can go ahead and debloat the unused parts. Navigate to the admin panel to the Debloating tab: <a class="reference external" href="http://localhost:8086/admin/software_file/description">http://localhost:8086/admin/software_file/description</a>.
Here, we have the option of file and function debloating. Remember that function debloating is a superset of file debloating where both unused files and unused functions are removed. Let’s click on “Debloat Functions” button.</p>
<p>This step can take a while as we are rewriting the source code of the whole application. If everything goes well, the text output will list the files and functions and whether they were covered, hence preserved or unused and removed.</p>
</div>
<div class="section" id="verifying-the-functionality-of-the-application-video-20-02">
<h2><em class="fa fa-arrow-right"></em> 7. Verifying The Functionality Of The Application <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=1202">[Video 20:02]</a><a class="headerlink" href="#verifying-the-functionality-of-the-application-video-20-02" title="Permalink to this headline">¶</a></h2>
<p>It’s time to go back to the application and start using it. For this step, we will be using <a class="reference external" href="http://localhost:8084/phpMyAdmin-4.4.15.6-all-languages/">http://localhost:8084/phpMyAdmin-4.4.15.6-all-languages/</a> since we do not want to train the application further. Repeat the tasks that you did before and make sure everything works. These include tasks such as login, and the items covered by the selenium scripts. Depending on the completeness of your tests, you will have a more functional application after debloating.</p>
<p>If there was an issue with the training part, you might try to use a feature that has been removed. If this happens, you will usually receive an error through the application UI. In some cases where an AJAX call fails, you can look at the Apache error.log to identify whether a removed file or function has been called. You can view the logs on Pulic Web container by first extracting the container id using <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> and then <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">logs</span> <span class="pre">-f</span> <span class="pre">[container_id]</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">Removed</span></code>.</p>
<p>If you think that you need to go back and retrain the application, first, revert the original copy of the application from the web/original directory.</p>
<ul class="simple">
<li><p>Navigate to the “web” directory.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">cp</span> <span class="pre">-R</span> <span class="pre">original/phpMyAdmin-4.4.15.6-all-languages</span> <span class="pre">.</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">-R</span> <span class="pre">777</span> <span class="pre">phpMyAdmin-4.4.15.6-all-languages/</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">644</span> <span class="pre">phpMyAdmin-4.4.15.6-all-languages/config.inc.php</span></code></p></li>
<li><p>Navigate to <code class="code docutils literal notranslate"><span class="pre">http://localhost:8086/admin/software_file/description</span></code> and <strong>rewrite destructors</strong>.</p></li>
</ul>
<p>Now that we have restored the original non-debloated application, you can go back to the training interface (<a class="reference external" href="http://localhost:8085/phpMyAdmin-4.4.15.6-all-languages/">http://localhost:8085/phpMyAdmin-4.4.15.6-all-languages/</a>) and rerun our tests to complete the training phase. Repeat the debloating and continue to this step until you are satisfied with the preserved functionality within the debloating application.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="line-block">
<div class="line"><em class="fa fa-eye"></em> <strong>Starting fresh</strong></div>
<div class="line">If for whatever reason something goes wrong that is beyond a simple fix like replacing the web appliction files, you can follow these instructions to rebuild the environment from scratch and go back to the state at the beginning of this tutorial.</div>
</div>
<ul class="simple">
<li><p><strong>Turn off the docker containers:</strong> Navigate to <code class="code docutils literal notranslate"><span class="pre">~/debloating_phpMyAdmin/</span></code>, type <code class="code docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">down</span></code>.</p></li>
<li><p><strong>Restore original files:</strong> Remove <code class="code docutils literal notranslate"><span class="pre">~/debloating_phpMyAdmin/</span></code> directory and decompress the tarball <code class="code docutils literal notranslate"><span class="pre">tar</span> <span class="pre">zxvf</span> <span class="pre">debloating_phpMyAdmin.tar.gz</span></code>.</p></li>
<li><p><strong>Rebuild docker containers:</strong> Navigate to <code class="code docutils literal notranslate"><span class="pre">~/debloating_phpMyAdmin/</span></code> and type <code class="code docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span></code>, you can use <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> to make sure all four containers are running at this point.</p></li>
<li><p><strong>Set the file permissions:</strong> Using <code class="code docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">-R</span> <span class="pre">777</span> <span class="pre">~/debloating_phpMyAdmin/web/phpMyAdmin-4.4.15.6-all-languages/</span></code> and <code class="code docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">644</span> <span class="pre">~/debloating_phpMyAdmin/web/phpMyAdmin-4.4.15.6-all-languages/config.inc.php</span></code>. Then use <code class="code docutils literal notranslate"><span class="pre">./ssh_admin.sh</span></code> and take ownership of web files <code class="code docutils literal notranslate"><span class="pre">chown</span> <span class="pre">-R</span> <span class="pre">www-data:www-data</span> <span class="pre">/var/www/html/phpMyAdmin-4.4.15.6-all-languages</span></code>.</p></li>
</ul>
</div>
</div>
<div class="section" id="running-the-exploit-on-the-debloated-version-video-20-22">
<h2><em class="fa fa-arrow-right"></em> 8. Running The Exploit On The Debloated Version <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=1222">[Video 20:22]</a><a class="headerlink" href="#running-the-exploit-on-the-debloated-version-video-20-22" title="Permalink to this headline">¶</a></h2>
<p>This exploit uses  a vulnerability in table find and replace functionality within phpMyAdmin. If this feature was never touched during training, debloating removes it from the application. As a result, the exploit attempts fail. Simply rerun the exploit and observe the result.</p>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><p>Rerunning same as before, this will either output:</p>
<div class="line-block">
<div class="line">- fail to parse the JSON because the field that its expecting is not there or</div>
<div class="line">- Exploit failed!</div>
<div class="line">Try to manually set exploit parameters like –table, –database and –token. Remember that servers with PHP version greater than 5.4.6 is not exploitable, because of warning about null byte in regexp</div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="source-code-metrics-after-debloating-video-20-52">
<h2><em class="fa fa-arrow-right"></em> 9. Source Code Metrics After Debloating <a class="reference external" href="https://youtu.be/W4RMhgaSsc8?t=1252">[Video 20:52]</a><a class="headerlink" href="#source-code-metrics-after-debloating-video-20-52" title="Permalink to this headline">¶</a></h2>
<p>Now it’s time to run phpmetrics again from the “training web” container and see the reduction in lines of code and cyclomatic complexity: <code class="code docutils literal notranslate"><span class="pre">phpmetrics</span> <span class="pre">phpMyAdmin-4.4.15.6-all-languages/</span></code></p>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<blockquote>
<div><p>Similar to previous step with reduced lines of code and reduced cyclomatic complexity.</p>
<div class="line-block">
<div class="line">Executing system analyzes…</div>
<div class="line">LOC Lines of code 24877</div>
<div class="line">Logical lines of code 14176</div>
<div class="line">…</div>
<div class="line">Complexity Average Cyclomatic</div>
<div class="line">complexity by class 24.85</div>
<div class="line">Average Relative system complexity 334.41</div>
<div class="line">Average Difficulty 13.03</div>
<div class="line">…</div>
<div class="line">Done</div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="working-with-other-debloated-applications">
<h2><a class="toc-backref" href="#id13">Working With Other Debloated Applications</a><a class="headerlink" href="#working-with-other-debloated-applications" title="Permalink to this headline">¶</a></h2>
<p>If you are interested in working with other application templates in our dataset, under <strong>debloating_Mediawiki</strong> and <strong>debloating_WordPress</strong> we have provided docker-containers with original and debloated version of applications. You should shutdown the existing container and start the other containers using <code class="code docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">down</span></code> in debloating_phpMyAdmin directory and <code class="code docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span></code> in Mediawiki or WordPress directories.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, PragSec Lab

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>